\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{hymnbook}[2025/04/19 Flowing hymns without spacing gaps]

\RequirePackage{titlesec}
\RequirePackage{parskip}
\RequirePackage{xcolor}
\RequirePackage{etoolbox}
\RequirePackage{lmodern}
\RequirePackage{geometry}
\RequirePackage{fancyhdr}
\RequirePackage{multicol}
\RequirePackage{everypage}
\RequirePackage{needspace}

% Page setup
\geometry{margin=1in}
\pagestyle{fancy}
\fancyhf{}
\rhead{\thepage}
\renewcommand{\headrulewidth}{0pt}

% Set up two-column layout without rule on first page
\AtBeginDocument{%
  \setlength{\columnsep}{1em}
  \setlength{\columnseprule}{0pt}
  \raggedcolumns % Prevent vertical stretching of columns (no spacing out)
  \begin{multicols}{2}
}

% Turn on dividing rule from page 2 onward
\AddEverypageHook{%
  \ifnum\value{page}>1
    \setlength{\columnseprule}{0.4pt}%
  \fi
}

% Close columns at end of document
\AtEndDocument{%
  \end{multicols}
}

% Hymn wrapper to keep hymn content together (prevent splitting)
\newenvironment{hymn}[2]{%
  \Needspace*{8\baselineskip} % Require space, else go to next column
  \vspace{0.5em}%
  {\bfseries #1~#2\par}%
  \addcontentsline{toc}{section}{#1~#2}%
  \markboth{#2}{#2}%
  \vspace{0.25em}%
}{%
  \vspace{1em}%
}

% Vertically stretched hymn number before first verse
\newcommand{\HymnNumberBeforeFirstVerse}[1]{%
  \raisebox{-0.3ex}{\parbox[c][2\baselineskip][c]{1.5em}{\centering\Huge\bfseries #1}}%
  \hspace{0.5em}%
}

% Stanza environment
\newenvironment{stanza}{%
  \begin{minipage}[t]{\linewidth}%
  \raggedright
}{%
  \end{minipage}\par\vspace{0.5em}%
}

% Chorus formatting: bold text, no label
\newenvironment{chorus}{%
  \vspace{0.5em}%
  \begin{minipage}[t]{\linewidth}%
  \raggedright\bfseries
}{%
  \end{minipage}\par\vspace{0.5em}%
}

% Optional manual break if needed
\newcommand{\HymnBreak}{\columnbreak}
